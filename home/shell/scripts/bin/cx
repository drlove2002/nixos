#!/usr/bin/env bash
set -e

VERBOSE=false
PATHS=()

# Parse flags and collect paths
while [[ $# -gt 0 ]]; do
    case $1 in
        -v|--verbose)
            VERBOSE=true
            shift
            ;;
        *)
            PATHS+=("$1")
            shift
            ;;
    esac
done

# Default to current directory if no paths provided
if [[ ${#PATHS[@]} -eq 0 ]]; then
    PATHS=(".")
fi

OUTPUT=""

# Process each path (directory or file)
for path in "${PATHS[@]}"; do
    if [[ ! -e "$path" ]]; then
        echo "⚠ Warning: Path does not exist: $path" >&2
        continue
    fi

    if [[ -d "$path" ]]; then
        # Handle directory
        OUTPUT+="## Directory: $path"$'\n'
        OUTPUT+="\`\`\`txt"$'\n'
        OUTPUT+="$(eza --tree --level=2 "$path")"$'\n'
        OUTPUT+="\`\`\`"$'\n\n'

        OUTPUT+="### File Contents"$'\n'

        while IFS= read -r file; do
            ext="${file##*.}"
            rel_path="${file#$path/}"
            
            OUTPUT+=$'\n'"#### ${rel_path}"$'\n'
            OUTPUT+="\`\`\`${ext}"$'\n'
            OUTPUT+="$(cat "${file}")"$'\n'
            OUTPUT+="\`\`\`"$'\n'

        done < <(fd . "$path" --type f -e rs -e js -e ts -e py -e sh -e md -e go -e c -e cpp)

    elif [[ -f "$path" ]]; then
        # Handle individual file
        filename=$(basename "$path")
        ext="${filename##*.}"
        
        OUTPUT+="## File: $path"$'\n'
        OUTPUT+="\`\`\`${ext}"$'\n'
        OUTPUT+="$(cat "${path}")"$'\n'
        OUTPUT+="\`\`\`"$'\n\n'
    fi
done

# Copy to clipboard or print
if command -v wl-copy &> /dev/null; then
    wl-copy "$OUTPUT"
    echo "✓ Copied to clipboard"
else
    echo "⚠ wl-copy not found, printing to stdout instead"
    VERBOSE=true
fi

# If verbose flag, print using bat or cat
if [[ "$VERBOSE" == true ]]; then
    if command -v bat &> /dev/null; then
        echo "$OUTPUT" | bat --language markdown
    else
        echo "$OUTPUT"
    fi
fi
